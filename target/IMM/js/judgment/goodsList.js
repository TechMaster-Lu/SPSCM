$(function(){function t(){$("td[aria-describedby=grid_name] span.sub_number").parents("tr").hide();for(var t=0;t<$("td[aria-describedby=grid_name] span[skuclassid]").length;t++)$("td[aria-describedby=grid_name] span[skuclassid]").eq(t).attr("skuclassid")!==$("td[aria-describedby=grid_name] span[skuclassid]").eq(t+1).attr("skuclassid")&&$("td[aria-describedby=grid_name] span[skuclassid]").eq(t).siblings(".number_sku").remove()}var e,i,a,r=parent.SYSTEM,n=Number(parent.SYSTEM.qtyPlaces),s=Number(parent.SYSTEM.pricePlaces),c=Number(parent.SYSTEM.amountPlaces),d=95,o=270,l=!0,u=1,g=[],m={operate:function(t,e){if("add"==t)var i="新增商品",a={oper:t,callback:this.callback};else if("add_goods_category"==t)var i="商品分类",a={oper:t,callback:this.callback};else if("copy"==t)var i="复制商品",a={oper:t,rowId:e,callback:this.callback};else var i="修改商品",a={oper:t,rowId:e,callback:this.callback};var r="setting-goodsManage",n="/settings/goods-manage.jsp?data="+JSON.stringify(a);"add_goods_category"==t&&(r="setting-goodsCategoryList",n="/settings/category-list.jsp?typeNumber=trade"),parent.tab.addTabItem({tabid:r,text:i,url:n})},batchSetGoods:function(t){var e={rowData:t,callback:this.batchCallback};$.dialog({width:700,height:300,title:"批量设置商品",content:"url:/settings/batchSetGoods.jsp",data:e,max:!1,min:!1,cache:!1,lock:!0})},del:function(t){$.dialog.confirm("删除的商品将不能恢复，请确认是否删除？",function(){Public.ajaxPost("../basedata/inventory.do?action=delete",{id:t},function(t){if(t&&200==t.status){for(var e=t.data,i=(e.successArr,0);i<e.successArr.length;i++)(a=e.successArr[i]).number=$("#grid").jqGrid("getRowData",a.id).name;for(i=0;i<e.failArr.length;i++){var a=e.failArr[i];a.number=$("#grid").jqGrid("getRowData",a.id).name}Public.showGoodsDeleteMsg(t.data,"商品"),$("#search").trigger("click")}else parent.Public.tips({type:1,content:"删除商品失败！"+t.msg})})})},commonSetStatus:function(t,e){t&&Public.ajaxPost("/basedata/inventory.do?action=setCommon",{id:t,isCommon:e},function(t){t&&200==t.status?(parent.Public.tips({content:"商品状态修改成功！"}),u=0,$("#search").trigger("click")):parent.Public.tips({type:1,content:"商品状态修改失败！"+t.msg})})},setStatus:function(t,e){t&&(e&&!Business.verifyRight("INVENTORY_禁用")||(0!=e||Business.verifyRight("INVENTORY_启用"))&&Public.ajaxPost("../basedata/inventory.do?action=disable",{invIds:t,disable:Number(e)},function(t){t&&200==t.status?(parent.Public.tips({content:"商品状态修改成功！"}),u=0,$("#search").trigger("click")):parent.Public.tips({type:1,content:"商品状态修改失败！"+t.msg})}))},setStatuses:function(t,e){if(t&&0!=t.length){var i=$("#grid").jqGrid("getGridParam","selarrrow").join();Public.ajaxPost("../basedata/inventory.do?action=disable",{invIds:i,disable:Number(e)},function(e){if(e&&200==e.status){parent.Public.tips({content:"商品状态修改成功！"});for(var i=0;i<t.length;i++){t[i];u=0,$("#search").trigger("click")}}else parent.Public.tips({type:1,content:"商品状态修改失败！"+e.msg})})}},callback:function(t,e,i){var a=$("#grid").data("gridData");a||(a={},$("#grid").data("gridData",a)),a[t.id]=t,"edit"==e?($("#grid").jqGrid("setRowData",t.id,t),"false"===$("#"+t.id).attr("aria-selected")&&$("#grid").jqGrid("setSelection",t.id),i&&i.api.close()):"copy"==e?($("#grid").jqGrid("addRowData",t.id,t,"last"),i&&i.api.close()):($("#grid").jqGrid("addRowData",t.id,t,"last"),i&&i.resetForm(t))},batchCallback:function(t,e,i){var a=$("#grid").data("gridData");a||(a={},$("#grid").data("gridData",a)),a[t.id]=t,$("#grid").jqGrid("setRowData",t.id,t),i&&i.api.close()}},p={money:function(t,e,i){return(t=Public.numToCurrency(t))||"&#160;"},currentQty:function(t,e,i){return"none"==t?"&#160;":t=Public.numToCurrency(t)},quantity:function(t,e,i){var t=parseFloat(t),a=n||2;if(0===t||isNaN(t))return"";var r=/(\d{1,3})(?=(\d{3})+(?:$|\D))/g;return(t=t.toFixed(a).split("."))[0].replace(r,"$1,")+"."+t[1]},unitsName:function(t,e,i){if(i.unitTypeId)t=i.unitTypeName;else var t=i.unitName;return t||"&#160;"},statusFmatter:function(t,e,a){var r;return a.id!==i?'<span class="set-status '+(!0===t?"close":"open")+'" data-delete="'+t+'" data-id="'+a.id+'"><span class="ui-icon-circle"></span></span>':(r="&#160;",i=a.id,r)},commonStatusFmatter:function(t,e,i){var r;return r=i.id!==a||l?'<span class="common-set-status '+(!1===t?"common-set-default":"common-set-success")+'" data-delete="'+t+'" data-id="'+i.id+'"></span>':"&#160;",l=!1,a=i.id,r},numberTagFmatter:function(t,e,i){var a=i.isSerNum?"SN":"",r=i.isWarranty?"批":"",n="";if(i.isSerNum&&i.isWarranty)n="/";return a+n+r||"&#160;"},numberFmatter:function(t,i,a){if(0!==a.skuId){var r=1;if(-1===$.inArray(a.id,g)&&(r=0),g.push(a.id),a.id&&0==r)t=a.name+'<span class="number_sku add"></span><span skuClassId="'+a.id+'"></span>';else t='<span skuClassId="'+a.id+'" class="sub_number"></span>';e=a.id}else{var t=a.name;e=a.id}return t||"&#160;"}},h=Public.mod_PageConfig.init("goodsList");!function(){var e=Public.setGrid(d,o),i=parent.SYSTEM.rights,a=!(parent.SYSTEM.isAdmin||i.AMOUNT_COSTAMOUNT),l=!(parent.SYSTEM.isAdmin||i.AMOUNT_INAMOUNT),u=!(parent.SYSTEM.isAdmin||i.AMOUNT_OUTAMOUNT),m=[{name:"operate",label:"操作",fixed:!0,formatter:function(t,e,i){return'<div class="operating" data-id="'+i.id+'"><span class="ui-icon ui-icon-pencil" title="修改"></span><span class="ui-icon ui-icon-copy" title="复制"></span><span class="ui-icon ui-icon-trash" title="删除"></span></div>'},width:100,title:!1},{name:"skuImageUrl",label:"sku图片",hidden:!0,formatter:function(t,e,i){return JSON.stringify(t)||""}},{name:"imageUrl",label:"图片",formatter:function(t,e,i){if(i.skuImageUrl)return s=(n=(a=i.skuImageUrl||$.parseJSON(i.skuImageUrl)).split("."))[0]+"_80x80."+n[1],'<img width="45" height="45" src="'+r.FilesDomain+s+'">';if(i.imageUrl){var a=i.imageUrl||$.parseJSON(i.imageUrl),n=a.split("."),s=n[0]+"_80x80."+n[1];return'<img width="45" height="45" src="'+r.FilesDomain+s+'">'}return""},classes:"img",align:"center",width:40},{name:"number",label:"商品编号",index:"number",width:100,title:!1,sortable:!0},{name:"name",label:"商品名称",index:"name",width:200,classes:"ui-ellipsis",sortable:!0}];1!==r.siType&&m.push({name:"numberTag",label:"商品标签",index:"numberTag",width:60,title:!1,formatter:p.numberTagFmatter},{name:"skuName",label:"辅助属性",index:"skuName",width:60,sortable:!1}),m.push({name:"categoryName",label:"商品类别",index:"categoryName",width:100,title:!1},{name:"spec",label:"规格型号",index:"spec",width:60,classes:"ui-ellipsis",sortable:!0},{name:"brandName",label:"商品品牌",index:"brandName",width:60},{name:"unitsName",label:"单位",index:"unitsName",formatter:p.unitsName,width:40,align:"center",title:!1},{name:"currentQty",label:"当前库存",index:"currentQty",width:80,align:"right",formatter:"number",formatoptions:{decimalPlaces:n},title:!1},{name:"quantity",label:"期初数量",index:"quantity",width:80,align:"right",title:!1,formatter:"number",formatoptions:{decimalPlaces:n}},{name:"unitCost",label:"单位成本",index:"unitCost",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:s},title:!1,hidden:a},{name:"amount",label:"期初总价",index:"amount",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:c},title:!1,hidden:a},{name:"purPrice",label:"预计采购价",index:"purPrice",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:s},title:!1,hidden:l},{name:"salePrice",label:"零售价",index:"salePrice",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:s},title:!1,hidden:u},{name:"retailPrice",label:"批发价",index:"retailPrice",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:s},title:!1,hidden:u},{name:"salePrice1",label:"VIP会员价",index:"salePrice1",width:100,align:"right",formatter:"currency",formatoptions:{decimalPlaces:s},title:!1,hidden:u},{name:"remark",label:"备注",index:"remark",width:100,title:!0},{name:"delete",label:"状态",index:"delete",width:80,align:"center",formatter:p.statusFmatter},{name:"common",label:"是否常用",index:"common",width:80,align:"center",formatter:p.commonStatusFmatter}),h.gridReg("grid",m),m=h.conf.grids.grid.colModel,$("#grid").jqGrid({url:"/basedata/inventory.do?action=listFormakeBill",datatype:"json",postData:{isDelete:"0"},width:e.w,height:e.h,altRows:!0,gridview:!0,onselectrow:!1,colModel:m,pager:"#page",viewrecords:!0,multiselect:!0,cmTemplate:{sortable:!1},sortname:"number",rowNum:$.cookie("pageNumber")||20,rowList:[20,100,200,500],shrinkToFit:!1,forceFit:!0,jsonReader:{root:"data.rows",records:"data.records",total:"data.total",repeatitems:!1,id:"id"},loadComplete:function(t){if(g=[],t&&200==t.status){var e={};t=t.data;for(var i=0;i<t.rows.length;i++){var a=t.rows[i];e[a.id]=a}$("#grid").data("gridData",e)}var r=$(".ui-paging-info").html();"无数据显示"==r?$(".ui-paging-info").html(r):$(".ui-paging-info").html("共"+r.split("共")[1]),Public.addDefUpArrow(this,m,!0)},gridComplete:function(e){setTimeout(function(){t()},100)},loadError:function(t,e,i){parent.Public.tips({type:1,content:"操作失败了哦，请检查您的网络链接！"})},resizeStop:function(t,e){h.setGridWidthByIndex(t,e,"grid")}})}(),Public.zTree.init($("#tree"),{defaultClass:"innerTree",showRoot:!0,rootTxt:"全部"},{callback:{beforeClick:function(t,e){$("#currentCategory").data("id",e.id).html(e.name),u=0,$("#search").trigger("click")}}}),$_matchCon=$("#matchCon"),$_matchCon.placeholder(),$("#config").show().click(function(t){h.config()}),$("#search").on("click",function(t){t.preventDefault();var i="按商品编号，商品名称，规格型号等查询"===$_matchCon.val()?"":$.trim($_matchCon.val()),a=$("#currentCategory").data("id"),r=!0===$("#chk-ischecked").find("span").hasClass("checked")?1:0;l=!0,$("#grid").jqGrid("setGridParam",{page:1,postData:{skey:i,assistId:a,isDelete:r,isUserOpt:u}}).trigger("reloadGrid"),e="",u=1}),$(document).on("click","#chk-ischecked",function(){e="";var t=$(this).find("span");t.hasClass("checked")?t.removeClass("checked"):t.addClass("checked"),u=0,$("#search").trigger("click")}),$("#grid").on("mouseenter",".img",function(t){var e=$(this);if(!e.data("initFloat")){var i=$(this).closest("tr")[0].id,a=$("#grid").jqGrid("getRowData",i),r=(a.imageUrl,a.imageUrl);if(r&&r){var n=$(".imgView");e.powerFloat({eventType:"hover",target:function(){return n},offsets:{x:0,y:0},position:"2-1",showCall:function(t){if(e.data("initFloat",!0),e.find("img")){var i=e.find("img").attr("src").replace("_80x80","");$("<img/>").attr("src",i).load(function(){realWidth=this.width,realHeight=this.height,realWidth>=250?n.attr("src",i).css("width","250px").css("height","250px"):n.attr("src",i).css("width","auto").css("height","auto")})}}}),e.trigger("mouseenter")}}}),$("#btn-refresh").click(function(t){t.preventDefault(),l=!0,$("#grid").trigger("reloadGrid"),e=""}),$("#btn-add").on("click",function(t){t.preventDefault(),Business.verifyRight("INVENTORY_ADD")&&m.operate("add")}),$("#btn-add-category").on("click",function(t){t.preventDefault(),Business.verifyRight("TRADETYPE_ADD")&&m.operate("add_goods_category")}),$("#btn-batchSet").on("click",function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_UPDATE")){var e=$("#grid").jqGrid("getGridParam","selarrrow"),i={};if(e.length){for(var a=0;a<e.length;a++){var r=$("#grid").data("gridData")[e[a]];i[e[a]]=r.name}m.batchSetGoods(i)}else parent.Public.tips({type:2,content:"请选择需要设置的项"})}}),$("#btn-print").on("click",function(t){t.preventDefault()}),$("#btn-import").on("click",function(t){t.preventDefault(),Business.verifyRight("INVENTORY_导入")&&parent.$.dialog({width:620,height:430,title:"商品导入",content:"url:/settings/goods-import.jsp",data:{importType:"inv"},lock:!0})}),$("#btn-export").on("click",function(t){if(Business.verifyRight("INVENTORY_EXPORT")){if(!Business.noDataExportTips())return!1;var e=$("#grid").jqGrid("getGridParam","selarrrow"),i="按商品编号，商品名称，规格型号等查询"===$_matchCon.val()?"":$.trim($_matchCon.val()),a=$("#currentCategory").data("id")||"",r=!0===$("#chk-ischecked").find("span").hasClass("checked")?1:0;$(this).attr("href","/basedata/inventory.do?action=exporter&isDelete="+r+"&skey="+i+"&assistId="+a+"&id="+e.join(","))}}),$("#grid").on("click",".operating .ui-icon-pencil",function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_UPDATE")){var e=$(this).parent().data("id");m.operate("edit",e)}}),$("#grid").on("click",".operating .ui-icon-copy",function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_ADD")){var e=$(this).parent().data("id");m.operate("copy",e)}}),$("#grid").on("click",".operating .ui-icon-trash",function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_DELETE")){var e=$(this).parent().data("id");m.del(e+"")}}),$("#grid").on("click",".operating .ui-icon-pic",function(t){t.preventDefault();var e=$(this).parent().data("id");$.dialog({content:"url:../settings/fileUpload.jsp",data:{title:"商品图片",id:e,callback:function(){}},title:"商品图片",width:775,height:470,max:!1,min:!1,cache:!1,lock:!0})}),$("#btn-batchDel").click(function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_DELETE")){var e=$("#grid").jqGrid("getGridParam","selarrrow");e.length?m.del(e.join()):parent.Public.tips({type:2,content:"请选择需要删除的项"})}}),$("#btn-disable").click(function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_禁用")){var e=$("#grid").jqGrid("getGridParam","selarrrow").concat();e&&0!=e.length?m.setStatuses(e,!0):parent.Public.tips({type:1,content:" 请先选择要禁用的商品！"})}}),$("#btn-enable").click(function(t){if(t.preventDefault(),Business.verifyRight("INVENTORY_启用")){var e=$("#grid").jqGrid("getGridParam","selarrrow").concat();e&&0!=e.length?m.setStatuses(e,!1):parent.Public.tips({type:1,content:" 请先选择要启用的商品！"})}}),$("#hideTree").click(function(t){t.preventDefault();var e=$(this);"&gt;&gt;"===e.html()?(e.html("&lt;&lt;"),o=0,$("#tree").hide(),Public.resizeGrid(d,o)):(e.html("&gt;&gt;"),o=270,$("#tree").show(),Public.resizeGrid(d,o))}),$(".ui-pg-selbox").on("change",function(){$.cookie("pageNumber",$(this).find("option:selected").val())}),$("#grid").on("click",".set-status",function(t){t.stopPropagation(),t.preventDefault();var e=$(this).data("id"),i=!$(this).data("delete");m.setStatus(e,i)}),$("#grid").on("click",".common-set-status",function(t){t.stopPropagation(),t.preventDefault();var e=$(this).data("id"),i=1==!$(this).data("delete")?"1":"0";m.commonSetStatus(e,i)}),$(window).resize(function(){Public.resizeGrid(d,o),$(".innerTree").height($("#tree").height()-95)}),Public.setAutoHeight($("#tree")),$(".innerTree").height($("#tree").height()-95),$("#matchCon").bind("keyup",function(t){var e=t||window.event;13==(e.keyCode||e.which||e.charCode)&&$("#search").click()}),$(document).on("click","td[aria-describedby=grid_name] .number_sku",function(t){t.preventDefault(),$this=$(this);var e=$this.siblings("span").attr("skuclassid");$this.hasClass("add")?($("td[aria-describedby=grid_name] span.sub_number[skuclassid="+e+"]").parents("tr").show(),$this.addClass("plus").removeClass("add")):($this.addClass("add").removeClass("plus"),$("td[aria-describedby=grid_name] span.sub_number[skuclassid="+e+"]").parents("tr").hide())})});